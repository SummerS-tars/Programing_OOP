# ICS

## 第 1 章：计算机系统漫游

这一章将带领我们对计算机系统进行一次整体的漫游。我们将通过一个简单的 “hello, world” 程序，了解它在系统中的生命周期——从源代码到可执行文件，再到最终在屏幕上显示结果的全过程，从而对系统中的硬件、操作系统和各个组件如何协同工作有一个宏观的认识。

### 1.1 信息就是“位+上下文”

计算机系统中所有的信息，无论是磁盘文件、内存中的程序、用户数据还是网络上传输的数据，本质上都是由一串比特（bits）来表示的。我们赋予这些比特序列不同的**上下文（context）**，才能解读它们的真实含义。

- **示例**：一个简单的 `hello.c` 程序。
    - 对于程序员来说，`hello.c` 是一个由 ASCII 字符组成的文本文件。
    - 然而，在系统内部，这个文件被表示为一串 0 和 1 的序列。
    - 当我们编译这个程序后，得到的 `hello` 可执行文件是另一串比特序列，但它的上下文已经变为**机器语言指令**，可以被处理器直接理解和执行。

```c
// hello.c 源代码
#include <stdio.h>

int main()
{
    printf("hello, world\n");
    return 0;
}
```

### 1.2 程序的翻译过程

一个C语言程序需要通过**编译系统**的四个阶段，才能从人类可读的源代码转变为机器可执行的代码。

1. **预处理 (Preprocessing)**：预处理器 (`cpp`) 根据以 `#` 开头的命令（如 `#include <stdio.h>`）修改原始C程序，生成一个 `.i` 文件。
2. **编译 (Compilation)**：编译器 (`cc1`) 将文本文件 `hello.i` 翻译成汇编语言程序 `hello.s`。汇编语言是机器语言的文本表示。
3. **汇编 (Assembly)**：汇编器 (`as`) 将 `hello.s` 翻译成机器语言指令，并将这些指令打包成一种称为**可重定位目标程序 (relocatable object program)** 的格式，保存在 `.o` 文件中。
4. **链接 (Linking)**：链接器 (`ld`) 负责将程序中引用的库函数（如 `printf`）的代码合并到我们的 `.o` 文件中，最终生成一个完整的、可以加载到内存中执行的**可执行目标文件 (executable object file)**。

### 1.3 系统的硬件组成

为了理解程序是如何运行的，我们需要了解一个典型系统的硬件构成。

- **总线 (Buses)**：贯穿整个系统的电子管道，负责在各个组件之间传递信息字节。
- **I/O 设备 (I/O Devices)**：是系统与外部世界的联系通道，如键盘、鼠标、显示器和磁盘。磁盘是用来长期存储可执行程序和数据的。
- **主存 (Main Memory)**：一个临时的存储设备，用于在处理器执行程序时存放程序和其处理的数据。从物理上看，主存是由一组**动态随机存取存储器 (DRAM)** 芯片组成的。
- **处理器 (CPU)**：中央处理单元，是解释和执行存储在主存中指令的引擎。
    - **程序计数器 (PC)**：CPU 核心的一个寄存器，它指向主存中下一条要执行的指令的地址。
    - **寄存器堆 (Register File)**：一个由少量寄存器组成的存储设备。
    - **算术/逻辑单元 (ALU)**：负责执行算术和逻辑运算。

### 1.4 “hello” 程序的执行之旅

当我们让系统执行 `hello` 程序时，发生了以下一系列事件：

1. **输入命令**：我们在键盘上输入字符串 `./hello`，shell 程序将字符逐一读入寄存器，再存放到主存中。
2. **加载程序**：当我们在键盘上敲下回车键后，shell 程序知道我们结束了命令输入。它会执行一系列指令来加载可执行的 `hello` 文件。这些指令将 `hello` 目标文件中的代码和数据从磁盘复制到主存。
3. **执行与输出**：一旦 `hello` 程序的代码和数据被加载到主存，处理器就开始执行 `main` 程序中的机器语言指令。这些指令将 "hello, world\n" 字符串中的字节从主存复制到寄存器堆，再从寄存器堆复制到显示设备，最终我们就在屏幕上看到了输出。

### 1.5 存储器层次结构

系统中的存储设备被组织成一个层次结构，从上到下，设备的访问速度越来越慢，容量越来越大，每字节的造价也越来越便宜。

- **L0: 寄存器 (Registers)**
- **L1: L1 缓存 (SRAM)**
- **L2: L2 缓存 (SRAM)**
- **L3: L3 缓存 (SRAM)**
- **L4: 主存 (DRAM)**
- **L5: 本地二级存储 (本地磁盘)**
- **L6: 远程二级存储 (分布式文件系统, Web服务器)**

**缓存 (Caching)** 是这个层次结构的核心思想。上一层的存储器作为其下一层存储器的高速缓存。通过这种方式，系统可以获得巨大的存储容量，同时又能以极快的速度访问数据，仿佛拥有一个又大又快的存储器。

### 1.6 操作系统的角色

**操作系统 (Operating System)** 是应用程序和硬件之间的中间层软件，它有两个主要功能：(1) 防止硬件被失控的应用程序滥用；(2) 向应用程序提供简单一致的机制来控制复杂的低级硬件设备。

为实现这两个功能，操作系统提出了几个关键的抽象概念：

- **进程 (Process)**：对处理器、主存和 I/O 设备的抽象。它是一个正在运行的程序的实例，为程序提供一种假象，仿佛它独占地使用系统资源。多个进程可以并发运行，由操作系统内核进行上下文切换。
- **虚拟内存 (Virtual Memory)**：对主存和磁盘的抽象。它为每个进程提供一个私有的、完整的地址空间，使得每个进程都感觉自己独占了主存。
- **文件 (File)**：对 I/O 设备的抽象，将所有 I/O 设备（如磁盘、键盘、网络）都视为字节序列。

### 1.7 系统知识的重要性 (The “Great Realities”)

作为程序员，为什么需要理解计算机系统的工作原理？

1. **整数和浮点数并非真实世界的数字**：计算机中的算术运算受到表示范围和精度的限制，可能会出现溢出或舍入误差，这与数学上的整数和实数运算不同。
2. **你需要了解汇编**：虽然我们很少直接编写汇编代码，但理解汇编是理解程序底层行为、调试疑难杂症和进行性能优化的关键。
3. **内存很重要**：内存不是无限的，必须小心管理。内存引用错误（如越界访问）非常隐蔽且有害。此外，缓存和虚拟内存对程序性能有巨大影响。
4. **性能不仅仅是渐进复杂度**：算法的时间复杂度很重要，但常数因子、编译和执行方式、内存访问模式等同样会极大地影响程序性能。
5. **计算机不只是执行程序**：它们还需要与外部世界进行数据交互（I/O），并通过网络进行通信，这些都带来了并发、可靠性和兼容性等系统级挑战。

---
